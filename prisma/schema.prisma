// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  owner
  customer
}

enum OrderStatus {
  new
  preparing
  ready
  out_for_delivery
  delivered
  completed
  cancelled
}

enum OrderType {
  dine_in
  takeaway
  delivery
}

enum CafeStatus {
  active
  suspended
}

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  email        String   @unique
  phone        String?
  passwordHash String?  @map("password_hash")
  role         UserRole @default(customer)
  address      String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cafesOwned     Cafe[]
  orders         Order[]
  favorites      Favorite[]
  rewardsAccount RewardsAccount[]
  rewardTxns     RewardTransaction[]

  @@map("users")
}

model Cafe {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String     @unique
  ownerUserId String     @map("owner_user_id") @db.ObjectId
  status      CafeStatus @default(active)
  phone       String
  email       String
  address     String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  owner            User                @relation(fields: [ownerUserId], references: [id])
  categories       MenuCategory[]
  menuItems        MenuItem[]
  orders           Order[]
  orderItems       OrderItem[]
  favorites        Favorite[]
  rewardsAccounts  RewardsAccount[]
  rewardTxns       RewardTransaction[]
  guestOrderTokens GuestOrderToken[]

  @@index([ownerUserId])
  @@map("cafes")
}

model MenuCategory {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  cafeId    String @map("cafe_id") @db.ObjectId
  name      String
  sortOrder Int    @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cafe  Cafe       @relation(fields: [cafeId], references: [id])
  items MenuItem[]

  @@index([cafeId, name])
  @@map("menu_categories")
}

model MenuItem {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  cafeId      String  @map("cafe_id") @db.ObjectId
  name        String
  description String?
  categoryId  String  @map("category_id") @db.ObjectId
  price       Int
  rating      Float?
  popular     Boolean @default(false)
  isActive    Boolean @default(true) @map("is_active")
  imageUrl    String? @map("image_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cafe       Cafe         @relation(fields: [cafeId], references: [id])
  category   MenuCategory @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  favorites  Favorite[]

  @@index([cafeId])
  @@index([categoryId])
  @@map("menu_items")
}

model Order {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  // If you want ORD-... instead, store it separately:
  // code           String       @unique

  cafeId          String  @map("cafe_id") @db.ObjectId
  userId          String? @map("user_id") @db.ObjectId
  guestEmail      String? @map("guest_email")
  guestPhone      String? @map("guest_phone")
  deliveryAddress String? @map("delivery_address")

  status OrderStatus @default(new)
  type   OrderType

  subtotal         Int
  deliveryFee      Int?      @map("delivery_fee")
  total            Int
  estimatedReadyAt DateTime? @map("estimated_ready_at")
  cancelledReason  String?   @map("cancelled_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cafe       Cafe                @relation(fields: [cafeId], references: [id])
  user       User?               @relation(fields: [userId], references: [id])
  items      OrderItem[]
  guestToken GuestOrderToken?
  rewardTxns RewardTransaction[]

  @@index([cafeId])
  @@index([userId])
  @@map("orders")
}

model OrderItem {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  cafeId     String @map("cafe_id") @db.ObjectId
  orderId    String @map("order_id") @db.ObjectId
  menuItemId String @map("menu_item_id") @db.ObjectId

  nameSnapshot  String  @map("name_snapshot")
  priceSnapshot Int     @map("price_snapshot")
  quantity      Int
  notes         String?

  // Relations
  cafe     Cafe     @relation(fields: [cafeId], references: [id])
  order    Order    @relation(fields: [orderId], references: [id])
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([cafeId])
  @@index([orderId])
  @@index([menuItemId])
  @@map("order_items")
}

model GuestOrderToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  cafeId    String   @map("cafe_id") @db.ObjectId
  orderId   String   @unique @map("order_id") @db.ObjectId
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  cafe  Cafe  @relation(fields: [cafeId], references: [id])
  order Order @relation(fields: [orderId], references: [id])

  @@index([cafeId])
  @@map("guest_order_tokens")
}

model RewardsAccount {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  cafeId        String   @map("cafe_id") @db.ObjectId
  userId        String   @map("user_id") @db.ObjectId
  pointsBalance Int      @default(0) @map("points_balance")
  level         String   @default("bronze")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  cafe Cafe @relation(fields: [cafeId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, cafeId])
  @@index([cafeId])
  @@map("rewards_accounts")
}

model RewardTransaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  cafeId      String   @map("cafe_id") @db.ObjectId
  userId      String   @map("user_id") @db.ObjectId
  pointsDelta Int      @map("points_delta")
  reason      String
  orderId     String?  @map("order_id") @db.ObjectId
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  cafe  Cafe   @relation(fields: [cafeId], references: [id])
  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  @@index([cafeId])
  @@index([userId])
  @@index([orderId])
  @@map("reward_transactions")
}

model Favorite {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  cafeId     String   @map("cafe_id") @db.ObjectId
  userId     String   @map("user_id") @db.ObjectId
  menuItemId String   @map("menu_item_id") @db.ObjectId
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  cafe     Cafe     @relation(fields: [cafeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@unique([userId, cafeId, menuItemId])
  @@index([cafeId])
  @@index([menuItemId])
  @@map("favorites")
}
